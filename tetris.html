<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- <link href="./fonts/7fonts.ru_DS-DIGI.TTF"> -->
	<!-- <link type="font/ttf" href="./fonts/362_LCDNOVA.ttf" rel="font/ttf"> -->
	<!-- <link href="toast.min.css" rel="stylesheet"> -->
	<!-- <script src="toast.min.js"></script> -->
    <title>Document</title>

    <style>

		@font-face {
			font-family: "DS-Digital";
			src: url("./fonts/DS-DIGIB.TTF");
		}

		.point {
			float: right;
			position: relative;
			font-family: "DS-Digital";
		}
		.point_l {
			float: right;
			position: relative;
			font-family: "DS-Digital";
		}
		.display-area {
			float: left;
			position: absolute;	
			top: 20px;
		}
		
        table{
            border-collapse: collapse;
            border-spacing: 0;
        }

        th, td {
			width: 8px;
			height: 8px;
			font-size: 40%;
            padding: 0;
			margin: 0;
            border: 0.1px solid #cdcdcd;
			cursor: default;
        }
		
		span:focus { 
			text-indent: -9999em; 
		}
	    span:focus {
			outline : none;
		}
		span:focus {
			outline: none;
			box-shadow: 0 0 1px 1px #4d90f0;
		}
		span:focus::-moz-placeholder {
			color: transparent;
		}
		span:focus::-webkit-input-placeholder {
			color: transparent;
		}
		
        canvas{
			font-size: 40%;

			margin: 0 auto;
			padding-left: 25%;
			padding-bottom: 5%;
			/* background:gray;
            border: none;
			cursor: crosshair; */
        }
		#container {
			padding: 10px;
			width: 155px;
			height: 220px;
			border: 0.1px solid #cdcdcd;
		}
		
    </style>
    <script type="text/javascript">  	
	
	function drawPast( id_canvas ) {
		var canvas = document.getElementById( id_canvas );
		try {
			if (canvas.getContext) {
				var ctx = canvas.getContext('2d');
				ctx.fillRect(0, 0, 8, 8);
			}		
		} catch (e) {
			null;
		}
	}
	
	function drawPastClear( id_canvas ) {
		var canvas = document.getElementById( id_canvas );
		try {
			if (canvas.getContext) {
				var ctx = canvas.getContext('2d');
				ctx.clearRect(0, 0, 8, 8);
			}		
		} catch (e) {
			null;
		}
	}
	
    </script>
</head>
<body>

<div id="container">
	<span class="point"></span>
	<br />
	<span class="point_l"></span>
	<script>
	
	var shape_1   = [['04', '05', '06', '15'], 1];
	var shape_2   = [['03', '04', '05', '06'], 2];
	
	var shape_all = [
					 [['04', '05', '06', '15'], 1],
					 [['03', '04', '05', '06'], 2]	
					];
					
	var down_wall = [140, 141, 142, 143, 144, 145, 146, 147, 148, 149];
	var up_wall   = [10,11,12,13,14,15,16,17,18,19];
	var fin_wall  = [20,21,22,23,24,25,26,27,28,29];
	var shape_mod = [];
	var arr_num   = 0;
	var wall 	  = [];
	var _score    = 0;
	var _speed    = 1000;
	
		function initGame() {
			var _l = 0;
			shape_mod = shape_all[0][0];
			arr_num = 0;
			document.querySelector('.point').innerHTML = 'S : ' + _score;
			
			
			if ( Number(_score) >= 500 ) {
				_speed = 800;
				_l = 1;
				
			} 
			if ( Number(_score) >= 1000 ) {
				_speed = 600;
				_l = 2;
			} 
			if ( Number(_score) >= 1500 ) {
				_speed = 500;
				_l = 3;
			} 
			if ( Number(_score) >= 2000 ) {
				_speed = 400;
				_l = 4;
			}
			if ( Number(_score) < 500 ) {
				_speed = 1000;
			} 
			
			document.querySelector('.point_l').innerHTML = 'L : ' + _l;
			console.log('_speed = ' + _speed);
		}
	
		function drawArea()
		{
			document.writeln("<span class='display-area'><table>");		
			for (var j = 0; j < 15; j++) {
				document.writeln("<tr>");

				for (var i = 0; i < 10; i++) {
					document.writeln("<td id=" + j + "" + i + "><canvas id='canva_" + j + "" + i + "' width='4' height='4'></canvas></td>");
				}
				document.writeln("</tr>");
			}
			document.writeln("</table></span>");	
			
			initGame();
			drawShape();			
		}
		
		function gameValidate(args) 
		{
			var j = 0;
			<!-- console.log(shape_mod); -->
			shape_mod.forEach( (item) => {

				if ( args.findIndex ( (el) => el == item ) != -1 ) {
					j++;
				} 

			});

			return j == 0 ? 1 : 0;
		}

		function drawShape() 
		{			
			
			drawShapePaint(shape_mod);
			
			<!-- if ( shape_mod[shape_mod.length - 1].toString().split('')[0] != '9') { -->
			if ( gameValidate(down_wall) == 1 ) {
				
				var i = 0;
				var arr_vilidate = wall.map(item => Number(item) - 10);
				
				for ( val of shape_mod ) {
					if ( arr_vilidate.includes(Number(val)) ) {	
						i++;
					}
				}					
				
				if ( i == 0 ) {			
				
				setTimeout( clearShape, _speed, shape_mod);	
				
				oneDownShape(shape_mod);
				
				setTimeout( drawShape, _speed);
					
				} else {
					wall = wall.concat(shape_mod);
					initGame();
					wall.sort( (a, b) => a - b );
					if ( gameValidate(wall) == 0 ) {
						<!-- console.log(shape_mod); -->
						<!-- console.log(wall); -->
						finishGame();
					} else {
						recurPoint(wall);
						<!-- console.log(wall); -->
						startGame();			
					}
				}	

			} else {
				wall = wall.concat(shape_mod);
				initGame();
				wall.sort( (a, b) => a - b );
				if ( gameValidate(wall) == 0 ) {
					<!-- console.log(shape_mod); -->
					<!-- console.log(wall); -->
					finishGame();
				} else {
					recurPoint(wall);
					<!-- console.log(wall); -->
					startGame();			
				}

			}			
			
		}
		

		function startGame() {
			
			initGame();
			<!-- shape_mod = shape_1; -->
			drawShape();		
		}
		
		function finishGame() {
			console.log('method finishGame()');
		}
		
		function recurPoint(arr) {

			var tmp = [];
			var mas = [];
			var del = [];
			var wall_foo = arr;
			var j = 0;
			
			for ( var i = 0; i < wall_foo.length; i++ ) {
			
				var m = wall_foo[i].toString().split('');

				if ( m[m.length - 1] == j ) {
				
				    j++;

					if ( j == 10 ) {
					
						 // извлечь начало массива и увеличиваем на 10
						tmp = arr.splice(0, i - 9).map(item => Number(item) + 10);

						//       console.log(mas);
						//       console.log(tmp);      
						//       console.log(arr);

						del = arr.splice(0, 10);
						//       console.log(del);
						clearShape(del);

						clearShape( tmp.map(item => Number(item) - 10) );
						//       console.log(arr);
						wall = tmp.concat(arr); // соединяем с остатками

						//       console.log(wall);
						wall.sort( (a, b) => a - b );

						drawShapePaint(wall);
						
						_score = _score + 100;
						
						initGame();
						recurPoint(wall);
					}
				} 
			}
			console.log(wall);
		}

		
		function drawShapePaint(shape) {
			
			for ( var i = 0; i < shape.length; i++ ) {
				document.getElementById(shape[i].toString()).style.backgroundColor = 'gray';
				document.getElementById(shape[i].toString()).style.borderColor = 'black'
				drawPast( 'canva_' + shape[i] );	
			}
			
		}
		
		function clearShape(shape) {
		
			for ( var i = 0; i < shape.length; i++) {
				document.getElementById(shape[i].toString()).style.background = 'none';
				document.getElementById(shape[i].toString()).style.border = '0.1px solid #cdcdcd';
				drawPastClear( 'canva_' + shape[i] );	
			}
		}
		
		function oneLeftShape(shape) {
			shape_mod = shape.map(item => Number(item) - 1);
		}
		
		function oneRightShape(shape) {
			shape_mod = shape.map(item => Number(item) + 1);
		}
		
		function oneDownShape(shape) {
			shape_mod = shape.map(item => Number(item) + 10);
			<!-- console.log(shape_mod); -->
		}
		
		function rotateShape(arr, num) {
			var tmp = [[arr[0], arr[1], arr[2], arr[3]],
					   [arr[0] - 9, arr[1] - 1, arr[2] - 1, arr[3]],
					   [arr[0], arr[1], arr[2], arr[3] - 9],
					   [arr[0], arr[1] + 1, arr[2] + 1, arr[3] + 9]
					  ];
			num++;
			
			if ( num == 4 ) {
				num = 0;
				tmp = [[arr[0] + 9, arr[1], arr[2], arr[3]]
					  ];
			}
			arr_num = num;
			// console.log(num);
			shape_mod = tmp[num];
		}

		function rotateShape_1(arr, num) {
			var tmp = [[arr[0], arr[1], arr[2], arr[3]],
					   [arr[0] - 9, arr[1] - 1, arr[2] - 1, arr[3]],
					   [arr[0], arr[1], arr[2], arr[3] - 9],
					   [arr[0], arr[1] + 1, arr[2] + 1, arr[3] + 9]
					  ];
			num++;
			
			if ( num == 4 ) {
				num = 0;
				tmp = [[arr[0] + 9, arr[1], arr[2], arr[3]]
					  ];
			}
			arr_num = num;
			// console.log(num);
			shape_mod = tmp[num];
		}
		
		drawArea();
		
		document.addEventListener('keydown', function(event) 
		{
			if (event.code == 'ArrowLeft') {
			
				oneLeftShape(shape_mod);
				
			} else if (event.code == 'ArrowRight') {
			
				oneRightShape(shape_mod);
				
			} else if (event.code == 'ArrowUp') {
			
				<!-- if ( shape_all[0][1] == 0 ) { -->
					if ( gameValidate(up_wall) == 1 ) {
						rotateShape(shape_mod, arr_num);
					<!-- }				 -->
				}
				<!-- if ( shape_all[0][1] == 1 ) { -->
					<!-- if ( gameValidate(up_wall) == 1 ) { -->
						<!-- rotateShape_1(shape_mod, arr_num); -->
					<!-- }				 -->
				<!-- } -->

			} else if (event.code == 'ArrowDown') {
			
				_speed = 10;
				
			}
		});	
		
	</script>
	
</div>



</body>
</html>
